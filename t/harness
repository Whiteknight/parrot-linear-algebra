#! parrot-nqp

INIT {
    pir::load_bytecode('rosella/harness.pbc');
    pir::load_bytecode('rosella/test.pbc');
    pir::load_bytecode('t/testlib/pla_test.pbc');
}

pir::say("A");
my $testfactory := Rosella::build(Rosella::Harness::TestRun::Factory);
pir::say("B");
my $harness := Rosella::build(Rosella::Harness);
pir::say("C");
my $testview := $harness.default_view();

$testfactory.add_test_dirs("NQP", "t", :recurse(0));
my $sanityrun := $testfactory.create;
$testview.add_run($sanityrun, 0);

$testfactory.add_test_dirs("NQP", 't/pmc',
    't/methods/nummatrix2d',
    't/methods/complexmatrix2d',
    't/methods/pmcmatrix2d',
    :recurse(0)
);
my $testrun := $testfactory.create;
$testview.add_run($testrun, 0);

# First run the sanity tests. The sanity tests load the dynamic library, which
# is required for everything else. Don't attempt to run any other tests if the
# sanity test fails
if ($harness.run($sanityrun, $testview)) {
    $harness.run($testrun, $testview);
}
$testview.show_results();
